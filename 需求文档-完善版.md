# Mora Video-to-Code 完善版需求文档

> **版本**: v2.0  
> **日期**: 2026-01-01  
> **最后更新**: 2026-01-01 08:15  
> **状态**: ✅ MVP已完成  
> **GitHub**: https://github.com/1692775560/intutionx  

---

## 📋 文档结构

本需求文档分为以下部分：
- **主文档**（本文件）：项目概述、产品定义、技术架构
- **前端实现规范**：`docs/前端实现规范.md`
- **后端实现规范**：`docs/后端实现规范.md`
- **API设计**：`docs/API设计.md`
- **部署和运维**：`docs/部署方案.md`

---

## 1. 项目概述

### 1.1 产品定位

**Mora** 是一个AI驱动的视频转代码教学平台，专注于编程教学视频的智能解析和交互式学习体验。

**核心价值**：
- 📹 **视频智能解析**：自动提取教学视频字幕并生成可运行代码
- ⚡ **实时同步体验**：视频播放时代码自动高亮对应讲解部分
- 🎯 **即时代码执行**：浏览器内直接运行Python代码，无需本地环境
- 💬 **AI辅助优化**：与AI对话改进和理解代码（UI已有，后端暂不实现）

### 1.2 目标用户

- **编程学习者**：观看教学视频时需要快速提取代码
- **内容创作者**：为视频教程生成配套代码文档
- **技术培训机构**：提升教学效率和学员体验

### 1.3 MVP范围

**✅ 必须实现的功能**：
1. 支持YouTube、Bilibili、TikTok视频URL输入
2. 自动提取视频字幕（BibiGPT API）
3. AI生成可运行的Python代码（DeepSeek API）
4. 生成时间轴映射（视频时间→代码行号）
5. 视频-代码同步播放和高亮
6. 前端代码编辑器（Monaco Editor）
7. 浏览器内代码执行（Pyodide）
8. SSE流式显示生成过程

**❌ 暂不实现**：
- 用户认证和个人账户
- 历史记录保存
- 代码分享功能
- 多语言支持（只支持Python）
- Chat对话功能后端（UI已有但暂不实现API）

---

## 2. 用户流程

### 2.1 完整用户旅程

```
1. 用户打开首页 (/)
   ↓
2. 输入视频URL（YouTube/Bilibili/TikTok）
   ↓
3. 点击 "Video to Code" 按钮
   ↓
4. 前端调用: POST /api/session
   返回: { sessionId: "xxx" }
   ↓
5. 跳转到: /workspace?session=xxx
   ↓
6. WorkspacePage自动建立SSE连接
   GET /api/session/xxx/stream
   ↓
7. 【后端处理流程 - SSE流式推送】
   ├─ event: thought → "正在验证视频URL..."
   ├─ event: thought → "正在提取字幕..."
   ├─ event: subtitle → { 字幕数据 }
   ├─ event: thought → "生成代码中..."
   ├─ event: code → "import..." (多次推送，流式显示)
   ├─ event: code_done → {}
   ├─ event: thought → "生成时间轴映射..."
   ├─ event: timeline → { segments: [...] }
   └─ event: done → {}
   ↓
8. 【用户交互】
   ├─ 播放视频 → 代码自动高亮
   ├─ 编辑代码 → Monaco Editor
   └─ 运行代码 → Pyodide执行 → 显示结果
```

### 2.2 页面结构

#### HomePage (/) - 首页
- 左侧边栏：Logo、菜单按钮
- 中间主体：品牌标题、输入框、快捷操作按钮
- 顶部导航：Sign In、Try for Free（暂无功能）

#### WorkspacePage (/workspace?session=xxx) - 核心工作区
```
┌──────────────────────────────────────────────────────┐
│  Header: Video to Code      [Chat] [Export]          │
├────────────────────┬─────────────────────────────────┤
│ Left (Resizable)   │  Right (Main Content)           │
│                    │                                 │
│ ┌────────────────┐ │ ┌─────────────────────────────┐ │
│ │ Video Preview  │ │ │ Generated Code              │ │
│ │ (视频播放器)    │ │ │ (Monaco Editor)             │ │
│ │ <video>        │ │ │ - 语法高亮                   │ │
│ └────────────────┘ │ │ - 行号显示                   │ │
│                    │ │ - 代码高亮（时间轴同步）      │ │
│ ┌────────────────┐ │ │ [Copy] [Run]                │ │
│ │ Agent Thought  │ │ └─────────────────────────────┘ │
│ │ Process        │ │                                 │
│ │ ✓ 提取字幕... │ │ ┌─────────────────────────────┐ │
│ │ ⊙ 生成代码... │ │ │ Execution Result            │ │
│ │ ○ 时间轴映射  │ │ │ (Pyodide output)            │ │
│ └────────────────┘ │ └─────────────────────────────┘ │
└────────────────────┴─────────────────────────────────┘
```

---

## 3. 技术架构

### 3.1 整体架构图

```
┌─────────────────────────────────────────────┐
│         用户浏览器 (Browser)                 │
│  ┌──────────────────────────────────────┐  │
│  │  React 18 + TypeScript + Vite        │  │
│  │  ├─ React Router (路由)              │  │
│  │  ├─ Monaco Editor (代码编辑)         │  │
│  │  ├─ Pyodide (Python执行引擎)         │  │
│  │  ├─ Radix UI + TailwindCSS (UI)     │  │
│  │  └─ EventSource (SSE客户端)          │  │
│  └──────────────────────────────────────┘  │
└─────────────┬───────────────────────────────┘
              │ HTTP/HTTPS + SSE
              ↓
┌─────────────────────────────────────────────┐
│      FastAPI Backend (Python 3.11+)         │
│  ┌──────────────────────────────────────┐  │
│  │  API Layer                           │  │
│  │  ├─ POST /api/session                │  │
│  │  ├─ GET /api/session/{id}            │  │
│  │  └─ GET /api/session/{id}/stream     │  │
│  ├──────────────────────────────────────┤  │
│  │  Business Logic                      │  │
│  │  ├─ VideoProcessor (URL验证)         │  │
│  │  ├─ BibiGPTService (字幕提取)        │  │
│  │  ├─ DeepSeekService (代码生成)       │  │
│  │  └─ TimelineService (时间轴生成)     │  │
│  └──────────────────────────────────────┘  │
└───┬─────────────────┬───────────────────────┘
    │                 │
┌───▼────┐      ┌─────▼──────┐
│PostgreSQL│      │   Redis    │
│(持久化)  │      │  (缓存)    │
└─────────┘      └────────────┘
    │
┌───▼──────────────────────┐
│    External APIs         │
│  ├─ BibiGPT (字幕)       │
│  └─ DeepSeek (AI生成)    │
└──────────────────────────┘
```

### 3.2 技术栈

#### 前端技术栈
- **React** 18.3.1 - UI框架
- **TypeScript** 5.x - 类型安全
- **Vite** 6.3.5 - 构建工具
- **React Router** 6.21.0 - 路由管理（需添加）
- **Monaco Editor** 4.6.0 - 代码编辑器（需添加）
- **Pyodide** 0.25.0 - Python运行时（需添加）
- **Radix UI** - 无障碍组件库（已有）
- **TailwindCSS** - 样式框架（已有）

#### 后端技术栈
- **Python** 3.11+
- **FastAPI** 0.108+
- **PostgreSQL** 15+
- **Redis** 7+
- **SQLAlchemy** 2.0+ / Alembic
- **Pydantic** 2.0+
- **httpx** - HTTP客户端

#### 第三方服务
- **BibiGPT API** - 视频字幕提取
- **DeepSeek API** - AI代码生成

---

## 4. 数据库设计

### 4.1 PostgreSQL Schema

```sql
CREATE TABLE sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    video_url TEXT NOT NULL,
    language VARCHAR(20) DEFAULT 'python',
    status VARCHAR(20) NOT NULL CHECK (status IN ('created', 'processing', 'completed', 'error')),
    
    -- 视频信息 (JSONB)
    video_info JSONB,
    
    -- 字幕数据 (JSONB)
    subtitles JSONB,
    
    -- 生成的代码
    generated_code TEXT,
    
    -- 时间轴映射 (JSONB)
    timeline JSONB,
    
    -- 错误信息
    error_message TEXT,
    
    -- 时间戳
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_sessions_status ON sessions(status);
CREATE INDEX idx_sessions_created_at ON sessions(created_at DESC);
```

### 4.2 Redis缓存设计

**缓存策略**：
```
Key: video:{videoUrl}:subtitle
Value: JSON字幕数据
TTL: 86400秒 (24小时)
用途: 避免重复调用BibiGPT API

Key: session:{sessionId}:result
Value: { code, timeline, videoInfo }
TTL: 3600秒 (1小时)
用途: 快速访问完成的会话结果
```

### 4.3 数据结构

**Timeline时间轴映射**：
```json
{
  "segments": [
    {
      "startTime": 0,
      "endTime": 30,
      "description": "课程介绍和环境准备",
      "codeLines": null
    },
    {
      "startTime": 30,
      "endTime": 120,
      "description": "导入必要的库",
      "codeLines": "1-8",
      "code": "import requests\nimport json..."
    },
    {
      "startTime": 120,
      "endTime": 250,
      "description": "定义数据抓取函数",
      "codeLines": "10-25"
    }
  ]
}
```

---

## 5. API设计

### 5.1 创建会话

```http
POST /api/session
Content-Type: application/json

Request:
{
  "videoUrl": "https://www.youtube.com/watch?v=xxx",
  "language": "python"
}

Response 201:
{
  "sessionId": "550e8400-e29b-41d4-a716-446655440000",
  "videoUrl": "https://...",
  "status": "created",
  "createdAt": "2026-01-01T05:39:00Z"
}

Error 400:
{
  "error": "INVALID_VIDEO_URL",
  "message": "视频URL不支持"
}
```

### 5.2 查询会话状态

```http
GET /api/session/{sessionId}

Response 200:
{
  "sessionId": "...",
  "videoUrl": "...",
  "status": "completed",
  "videoInfo": { "title": "...", "duration": 1234 },
  "generatedCode": "import...",
  "timeline": { "segments": [...] },
  "createdAt": "...",
  "updatedAt": "..."
}
```

### 5.3 SSE流式推送

```http
GET /api/session/{sessionId}/stream
Accept: text/event-stream

Response Stream:
event: thought
data: {"content": "正在提取字幕..."}

event: code
data: {"content": "import requests\n"}

event: timeline
data: {"segments": [...]}

event: done
data: {}
```

**SSE事件类型**：
- `thought` - AI思考过程
- `subtitle` - 字幕提取完成
- `code` - 代码片段（流式追加）
- `code_done` - 代码生成完成
- `timeline` - 时间轴映射
- `done` - 全部完成
- `error` - 错误信息

---

## 6. 环境配置

### 6.1 前端环境变量

```bash
# .env
VITE_API_URL=http://localhost:8000
```

### 6.2 后端环境变量

```bash
# .env
# 数据库
DATABASE_URL=postgresql://mora:password@localhost:5432/mora

# Redis
REDIS_URL=redis://localhost:6379/0

# BibiGPT API
BIBIGPT_API_KEY=your_bibigpt_api_key_here
BIBIGPT_API_URL=https://api.bibigpt.co/api/v1

# DeepSeek API
DEEPSEEK_API_KEY=your_deepseek_api_key_here
DEEPSEEK_API_URL=https://api.deepseek.com/v1
DEEPSEEK_MODEL=deepseek-coder

# 功能配置
DEBUG=False
ENABLE_CACHE=true
CACHE_TTL=3600
MAX_VIDEO_DURATION=7200

# 限流
MAX_REQUESTS_PER_MINUTE=10
```

---

## 7. 开发计划

### 7.1 开发阶段

**阶段1：基础设施（1-2天）**
- [ ] 创建后端FastAPI项目结构
- [ ] 配置PostgreSQL + Alembic迁移
- [ ] 配置Redis连接
- [ ] 前端添加依赖（Monaco Editor、Pyodide、React Router）
- [ ] 实现环境变量管理

**阶段2：核心功能（3-5天）**
- [ ] 实现POST /api/session（创建会话）
- [ ] 集成BibiGPT API（字幕提取）
- [ ] 集成DeepSeek API（代码生成）
- [ ] 实现SSE流式推送
- [ ] 前端添加React Router
- [ ] 前端集成Monaco Editor
- [ ] 实现视频-代码同步逻辑

**阶段3：代码执行（2-3天）**
- [ ] 前端集成Pyodide
- [ ] 实现代码执行和结果展示
- [ ] 处理执行错误和超时

**阶段4：优化和部署（2-3天）**
- [ ] 添加错误处理和用户提示
- [ ] 实现Redis缓存策略
- [ ] 编写Docker Compose配置
- [ ] 选择部署平台并部署
- [ ] 测试完整流程

**预计总开发时间**：8-13天

### 7.2 优先级排序

| P0（必须） | P1（重要） | P2（优化） |
|-----------|-----------|-----------|
| 视频URL验证 | 错误处理 | Chat功能 |
| 字幕提取 | Redis缓存 | 历史记录 |
| 代码生成 | 日志系统 | 用户认证 |
| 时间轴映射 | 监控告警 | 代码分享 |
| 视频同步 | 性能优化 | 多语言 |
| 代码执行 | Docker部署 | - |

---

## 8. 风险和注意事项

### 8.1 技术风险

| 风险项 | 影响 | 缓解措施 |
|-------|------|---------|
| Pyodide加载慢 | 用户体验差 | 显示加载动画，预加载优化 |
| BibiGPT API成本 | 运营成本高 | Redis缓存，评估成本 |
| DeepSeek生成质量 | 代码不可运行 | 添加代码验证，优化Prompt |
| 视频时长过长 | 处理超时 | 限制最大2小时 |
| SSE连接中断 | 数据丢失 | 可恢复设计，查询状态API |

### 8.2 产品决策点

**需要明确的问题**：
1. **BibiGPT API费用**：需要评估成本，是否需要限制用户使用次数？
2. **视频时长限制**：目前设置2小时，是否合理？
3. **代码生成失败**：如果AI生成的代码无法运行，如何处理？
4. **并发限制**：MVP阶段支持多少并发用户？
5. **用户认证**：何时添加用户系统？

---

## 9. 下一步行动

### 9.1 立即开始

1. **创建后端项目**
   ```bash
   mkdir mora-backend
   cd mora-backend
   python -m venv venv
   source venv/bin/activate
   pip install fastapi uvicorn sqlalchemy ...
   ```

2. **安装前端依赖**
   ```bash
   cd "Video Conversion App Design"
   npm install @monaco-editor/react pyodide react-router-dom
   ```

3. **配置环境变量**
   - 复制 `.env.example` 到 `.env`
   - 填写API Keys

4. **启动开发环境**
   ```bash
   # 后端
   uvicorn app.main:app --reload
   
   # 前端
   npm run dev
   ```

### 9.2 参考文档

详细实现请参考：
- 📘 **前端实现规范**：`docs/前端实现规范.md`
- 📗 **后端实现规范**：`docs/后端实现规范.md`
- 📙 **部署方案**：`docs/部署方案.md`

---

## 10. 总结

**Mora项目特点**：
- ✅ 产品定位清晰（视频转代码教学工具）
- ✅ 技术栈合理（React + FastAPI + AI服务）
- ✅ 前端UI已完成90%（Figma生成）
- ⚠️ 需要补充核心依赖和逻辑
- ⚠️ 需要创建完整的后端系统

**关键成功因素**：
1. **BibiGPT API稳定性**：字幕提取的核心依赖
2. **DeepSeek生成质量**：代码可运行性直接影响用户体验
3. **Pyodide性能优化**：首次加载体验很关键
4. **视频同步准确性**：时间轴映射的准确度

**建议开发顺序**：
后端基础设施 → API集成 → 前端完善 → 联调测试 → 部署上线
