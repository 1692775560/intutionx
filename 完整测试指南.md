# Mora 完整测试指南

> 最后更新：2026-01-01 08:15  
> GitHub仓库：https://github.com/1692775560/intutionx

## 🎉 当前状态

### ✅ 前端服务
- **地址**: http://localhost:3000
- **状态**: ✅ 运行中
- **功能**: UI界面、视频URL输入、代码展示

### ✅ 后端服务
- **地址**: http://localhost:8000
- **API文档**: http://localhost:8000/docs
- **状态**: ✅ 运行中
- **功能**: 字幕提取、代码生成、SSE流式推送

### ✅ 数据库服务
- **PostgreSQL 15**: localhost:5432 ✅ 运行中
- **Redis 7**: localhost:6379 ✅ 运行中
- **数据库**: mora ✅ 已创建并迁移

### ✅ API密钥
- **BibiGPT**: `pyUCIr0m4FLU` ✅
- **DeepSeek**: `sk-ce51524faa084f4c92bbbf32cca843cb` ✅

---

## 🧪 测试流程

### 测试1：访问前端界面

1. **打开浏览器**访问：http://localhost:3000

**预期效果**：
- ✅ 看到精美的首页设计
- ✅ 输入框带打字机动画效果
- ✅ "Video to Code" 等快捷操作按钮
- ✅ 作品展示画廊

---

### 测试2：查看后端API文档

1. **打开浏览器**访问：http://localhost:8000/docs

**预期效果**：
- ✅ 看到SwaggerUI交互式API文档
- ✅ 3个端点：
  - `POST /api/session` - 创建会话
  - `GET /api/session/{session_id}` - 获取会话
  - `GET /api/session/{session_id}/stream` - SSE流式推送

---

### 测试3：测试后端健康检查

```bash
curl http://localhost:8000/health
```

**预期响应**：
```json
{
  "status": "healthy",
  "version": "1.0.0"
}
```

---

### 测试4：完整的视频转代码流程 ⭐ 重要

#### 步骤1：输入视频URL

1. 打开 http://localhost:3000
2. **在页面中央的大输入框中**输入视频URL
   - 推荐测试URL：`https://www.bilibili.com/video/BV1qW4y1a7fU`
   - 支持：YouTube、Bilibili、TikTok
3. 点击下方的 **"Video to Code"** 快捷操作按钮

**注意**：现在使用主输入框输入URL，不再有弹窗

**⚠️ 注意**：如果没有安装PostgreSQL，会看到数据库连接错误。这是正常的，继续看测试5。

---

### 测试5：直接测试API（不需要数据库）

#### 使用API文档测试

1. 访问：http://localhost:8000/docs
2. 展开 `POST /api/session`
3. 点击 **"Try it out"**
4. 输入测试数据：
```json
{
  "videoUrl": "https://www.bilibili.com/video/BV1xx411c7mD",
  "language": "python"
}
```
5. 点击 **Execute**

**可能的结果**：

**情况A - 数据库未安装**：
```json
{
  "detail": {
    "error": "3002",
    "message": "数据库操作失败"
  }
}
```
👉 **解决方案**：参考下面的"安装PostgreSQL"部分

**情况B - 成功创建会话**：
```json
{
  "sessionId": "550e8400-e29b-41d4-a716-446655440000",
  "videoUrl": "https://www.bilibili.com/video/BV1xx411c7mD",
  "status": "created",
  "createdAt": "2026-01-01T06:30:00Z"
}
```
✅ 成功！继续测试SSE流式推送

---

### 测试6：测试SSE流式推送（需要数据库）

**使用curl测试**：
```bash
# 先创建会话（如果数据库已配置）
SESSION_ID="your-session-id-here"

# 连接SSE流
curl -N http://localhost:8000/api/session/$SESSION_ID/stream
```

**预期输出**（实时流式）：
```
event: thought
data: {"content":"正在验证视频URL..."}

event: thought
data: {"content":"正在提取字幕，请稍候..."}

event: subtitle
data: {"title":"Python教程","duration":600,"subtitles":[...]}

event: thought
data: {"content":"正在分析视频内容并生成代码..."}

event: code
data: {"content":"import numpy as np\n"}

event: code
data: {"content":"import pandas as pd\n"}

event: code_done
data: {}

event: timeline
data: {"segments":[...]}

event: done
data: {}
```

---

## 🗄️ 安装PostgreSQL（必需步骤）

### macOS安装

```bash
# 安装PostgreSQL
brew install postgresql@15

# 启动服务
brew services start postgresql@15

# 创建数据库
createdb mora

# 验证
psql mora -c "SELECT version();"
```

### 运行数据库迁移

```bash
cd /Users/Zhuanz/Desktop/Mora/mora-backend
source venv/bin/activate
alembic upgrade head
```

**成功输出**：
```
INFO  [alembic.runtime.migration] Running upgrade  -> 001, create sessions table
```

### 重启后端（使数据库生效）

```bash
# Ctrl+C 停止当前后端
# 然后重新启动
cd /Users/Zhuanz/Desktop/Mora/mora-backend
source venv/bin/activate
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

---

## 🧪 完整功能测试（数据库配置后）

### 测试场景：处理一个真实视频

1. **前端操作**：
   - 访问：http://localhost:3000
   - 输入视频URL：`https://www.bilibili.com/video/BV1xx411c7mD`
   - 点击 "Video to Code"

2. **预期流程**：
   - ✅ 跳转到工作区页面（`/workspace?session=xxx`）
   - ✅ 左侧显示"AI思考过程"
   - ✅ 实时显示处理进度
   - ✅ 代码区域流式显示生成的Python代码
   - ✅ 处理完成后显示"Run"按钮

3. **执行代码**：
   - 等待Pyodide加载完成（首次加载需要3-5秒）
   - 点击 "Run" 按钮
   - 查看执行结果

---

## 📊 测试检查清单

### 前端测试
- [ ] 首页加载正常
- [ ] 输入框可输入文字
- [ ] 快捷操作按钮可点击
- [ ] "Video to Code"按钮触发跳转

### 后端测试
- [ ] `/health` 端点返回healthy
- [ ] API文档可访问
- [ ] 创建会话API工作
- [ ] SSE流式推送正常

### 数据库测试（可选）
- [ ] PostgreSQL已安装并运行
- [ ] 数据库迁移成功
- [ ] 会话数据可以保存
- [ ] 会话数据可以查询

### 完整流程测试
- [ ] 前端提交视频URL
- [ ] 后端提取字幕成功
- [ ] 代码流式生成
- [ ] 时间轴映射生成
- [ ] Pyodide执行代码成功

---

## 🐛 常见问题

### 1. 数据库连接失败

**错误**：`sqlalchemy.exc.OperationalError`

**解决**：
```bash
# 检查PostgreSQL是否运行
brew services list | grep postgresql

# 如果未运行，启动它
brew services start postgresql@15

# 确认数据库存在
psql -l | grep mora

# 如果不存在，创建它
createdb mora
```

### 2. Redis连接失败

**错误**：`redis.exceptions.ConnectionError`

**解决**：
```bash
# 安装Redis
brew install redis

# 启动Redis
brew services start redis

# 验证
redis-cli ping
# 应该返回: PONG
```

### 3. 前端无法连接后端

**错误**：前端显示"Failed to create session"

**检查**：
- 后端是否运行：访问 http://localhost:8000/health
- CORS配置是否正确：检查 `.env` 中的 `CORS_ORIGINS`
- 前端环境变量：检查 `Video Conversion App Design/.env`

### 4. API密钥错误

**错误**：BibiGPT或DeepSeek返回401

**检查**：
```bash
# 查看后端日志中的API密钥（前几位）
cat /Users/Zhuanz/Desktop/Mora/mora-backend/.env | grep API_KEY

# 应该看到：
# BIBIGPT_API_KEY=pyUCIr0m4FLU
# DEEPSEEK_API_KEY=sk-ce51524faa084f4c92bbbf32cca843cb
```

### 5. Pyodide加载失败

**症状**：前端显示"Loading Python runtime..."一直不消失

**解决**：
- 检查网络连接（Pyodide从CDN加载）
- 清空浏览器缓存重试
- 等待更长时间（首次加载可能需要5-10秒）

---

## 🎯 推荐测试顺序

### 快速测试（5分钟）
1. ✅ 访问前端界面
2. ✅ 访问后端API文档
3. ✅ 测试健康检查端点
4. ⚠️ 注意数据库警告（可以稍后配置）

### 完整测试（30分钟）
1. ✅ 安装PostgreSQL和Redis
2. ✅ 运行数据库迁移
3. ✅ 重启后端服务
4. ✅ 测试完整的视频转代码流程
5. ✅ 验证代码执行功能

---

## 📝 测试记录模板

```markdown
## 测试日期：2026-01-01

### 环境检查
- [ ] 前端运行：http://localhost:3000
- [ ] 后端运行：http://localhost:8000
- [ ] PostgreSQL：已安装 / 未安装
- [ ] Redis：已安装 / 未安装

### 功能测试
- [ ] 视频URL验证：通过 / 失败
- [ ] 字幕提取：成功 / 失败
- [ ] 代码生成：成功 / 失败
- [ ] SSE推送：正常 / 异常
- [ ] 代码执行：成功 / 失败

### 遇到的问题
1. [描述问题]
2. [解决方案]

### 测试结论
- 总体状态：✅ 正常 / ⚠️ 部分功能 / ❌ 不可用
- 需要改进：[列出需要改进的地方]
```

---

## 🚀 下一步

### 如果测试全部通过
✅ 恭喜！系统已经可以正常使用了。

**可以尝试**：
- 测试不同平台的视频（YouTube、Bilibili、TikTok）
- 调整代码生成的Prompt
- 优化时间轴映射算法
- 添加更多编程语言支持

### 如果遇到问题
1. 查看上面的"常见问题"部分
2. 检查控制台日志
3. 参考详细文档：
   - `前端配置说明.md`
   - `docs/前端实现规范.md`
   - `mora-backend/README.md`

---

## 📞 需要帮助？

如果遇到任何问题，请记录：
1. 具体的错误信息
2. 复现步骤
3. 浏览器控制台日志
4. 后端终端输出

祝测试顺利！🎉
