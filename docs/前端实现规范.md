# 前端实现规范

> 配合主需求文档使用

## 1. 项目结构

```
Video Conversion App Design/
├── public/
│   └── pyodide/              # Pyodide缓存目录（自动生成）
├── src/
│   ├── main.tsx              # 入口文件
│   ├── App.tsx               # 根组件
│   ├── index.css             # 全局样式
│   │
│   ├── pages/                # 页面组件（新增）
│   │   ├── Home.tsx          # 首页
│   │   └── Workspace.tsx     # 工作区页面
│   │
│   ├── components/           # 组件（已有+新增）
│   │   ├── Sidebar.tsx       # 侧边栏（已有）
│   │   ├── HomePage.tsx      # 首页内容（已有，需修改）
│   │   ├── WorkspacePage.tsx # 工作区（CodePage重命名）
│   │   ├── CodeEditor.tsx    # Monaco编辑器（新增）
│   │   ├── VideoPlayer.tsx   # 视频播放器（新增）
│   │   └── ui/               # UI组件库（已有）
│   │
│   ├── hooks/                # 自定义Hooks（新增）
│   │   ├── usePyodide.ts     # Pyodide Hook
│   │   ├── useSSE.ts         # SSE Hook
│   │   └── useVideoSync.ts   # 视频同步Hook
│   │
│   ├── services/             # API服务（新增）
│   │   └── api.ts            # API封装
│   │
│   ├── types/                # TypeScript类型（新增）
│   │   ├── session.ts
│   │   └── timeline.ts
│   │
│   └── utils/                # 工具函数（新增）
│       ├── codeHighlight.ts
│       └── timeFormat.ts
│
├── package.json              # 需更新依赖
├── vite.config.ts
├── tsconfig.json
└── README.md
```

## 2. 依赖更新

### 2.1 需要添加的依赖

```bash
npm install react-router-dom @monaco-editor/react pyodide
```

### 2.2 完整的package.json依赖

```json
{
  "dependencies": {
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "react-router-dom": "^6.21.0",
    "@monaco-editor/react": "^4.6.0",
    "pyodide": "^0.25.0",
    "@radix-ui/react-*": "（保持现有版本）",
    "lucide-react": "^0.487.0",
    "re-resizable": "*",
    "clsx": "*",
    "tailwind-merge": "*",
    "class-variance-authority": "^0.7.1"
  },
  "devDependencies": {
    "@types/node": "^20.10.0",
    "@vitejs/plugin-react-swc": "^3.10.2",
    "typescript": "^5.3.0",
    "vite": "6.3.5"
  }
}
```

## 3. 路由配置

### 3.1 修改main.tsx

```typescript
// src/main.tsx
import React from 'react';
import ReactDOM from 'react-dom/client';
import { BrowserRouter, Routes, Route } from 'react-router-dom';
import HomePage from './pages/Home';
import WorkspacePage from './pages/Workspace';
import './index.css';

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <BrowserRouter>
      <Routes>
        <Route path="/" element={<HomePage />} />
        <Route path="/workspace" element={<WorkspacePage />} />
      </Routes>
    </BrowserRouter>
  </React.StrictMode>
);
```

### 3.2 创建页面组件

**src/pages/Home.tsx**:
```typescript
import { Sidebar } from '../components/Sidebar';
import { HomePage } from '../components/HomePage';

export default function Home() {
  return (
    <div className="flex h-screen bg-white">
      <Sidebar currentPage="home" setCurrentPage={() => {}} />
      <main className="flex-1 overflow-hidden">
        <HomePage />
      </main>
    </div>
  );
}
```

**src/pages/Workspace.tsx**:
```typescript
import { useSearchParams } from 'react-router-dom';
import { Sidebar } from '../components/Sidebar';
import { WorkspacePage } from '../components/WorkspacePage';

export default function Workspace() {
  const [searchParams] = useSearchParams();
  const sessionId = searchParams.get('session');

  if (!sessionId) {
    return <div>Invalid session</div>;
  }

  return (
    <div className="flex h-screen bg-white">
      <Sidebar currentPage="code" setCurrentPage={() => {}} />
      <main className="flex-1 overflow-hidden">
        <WorkspacePage sessionId={sessionId} />
      </main>
    </div>
  );
}
```

## 4. TypeScript类型定义

### 4.1 会话类型

```typescript
// src/types/session.ts
export type SessionStatus = 'created' | 'processing' | 'completed' | 'error';

export interface VideoInfo {
  title: string;
  duration: number;
  thumbnail: string;
  author?: string;
}

export interface Session {
  sessionId: string;
  videoUrl: string;
  status: SessionStatus;
  videoInfo?: VideoInfo;
  generatedCode?: string;
  timeline?: Timeline;
  error?: string;
  createdAt: string;
  updatedAt: string;
}
```

### 4.2 时间轴类型

```typescript
// src/types/timeline.ts
export interface TimelineSegment {
  startTime: number;      // 秒
  endTime: number;        // 秒
  description: string;
  codeLines: string | null; // "1-10" or null
  code?: string;
}

export interface Timeline {
  segments: TimelineSegment[];
}
```

## 5. API服务封装

```typescript
// src/services/api.ts
const API_BASE_URL = import.meta.env.VITE_API_URL || 'http://localhost:8000';

export interface CreateSessionRequest {
  videoUrl: string;
  language?: string;
}

export interface SessionResponse {
  sessionId: string;
  videoUrl: string;
  status: 'created' | 'processing' | 'completed' | 'error';
  videoInfo?: {
    title: string;
    duration: number;
    thumbnail: string;
  };
  generatedCode?: string;
  timeline?: any;
  error?: string;
  createdAt: string;
  updatedAt: string;
}

export const api = {
  async createSession(request: CreateSessionRequest): Promise<SessionResponse> {
    const response = await fetch(`${API_BASE_URL}/api/session`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(request),
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.message || 'Failed to create session');
    }

    return response.json();
  },

  async getSession(sessionId: string): Promise<SessionResponse> {
    const response = await fetch(`${API_BASE_URL}/api/session/${sessionId}`);

    if (!response.ok) {
      throw new Error('Session not found');
    }

    return response.json();
  },
};
```

## 6. 核心Hooks实现

### 6.1 usePyodide Hook

```typescript
// src/hooks/usePyodide.ts
import { useState, useEffect, useCallback } from 'react';
import { loadPyodide, PyodideInterface } from 'pyodide';

export function usePyodide() {
  const [pyodide, setPyodide] = useState<PyodideInterface | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    let mounted = true;

    async function init() {
      try {
        console.log('Loading Pyodide...');
        const pyodideInstance = await loadPyodide({
          indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.25.0/full/',
        });
        
        // 预加载常用包
        console.log('Loading packages...');
        await pyodideInstance.loadPackage(['numpy', 'pandas']);
        
        if (mounted) {
          setPyodide(pyodideInstance);
          setLoading(false);
          console.log('Pyodide ready');
        }
      } catch (err) {
        if (mounted) {
          setError(err instanceof Error ? err.message : 'Failed to load Pyodide');
          setLoading(false);
        }
      }
    }

    init();

    return () => {
      mounted = false;
    };
  }, []);

  const runCode = useCallback(
    async (code: string): Promise<{ output: string; error: string | null }> => {
      if (!pyodide) {
        return { output: '', error: 'Pyodide not initialized' };
      }

      try {
        // 重定向stdout和stderr
        await pyodide.runPythonAsync(`
import sys
from io import StringIO
sys.stdout = StringIO()
sys.stderr = StringIO()
        `);

        // 执行用户代码
        await pyodide.runPythonAsync(code);

        // 获取输出
        const stdout = pyodide.runPython('sys.stdout.getvalue()');
        const stderr = pyodide.runPython('sys.stderr.getvalue()');

        return {
          output: stdout,
          error: stderr || null,
        };
      } catch (err) {
        return {
          output: '',
          error: err instanceof Error ? err.message : 'Execution failed',
        };
      }
    },
    [pyodide]
  );

  return { pyodide, loading, error, runCode };
}
```

### 6.2 useSSE Hook

```typescript
// src/hooks/useSSE.ts
import { useState, useEffect } from 'react';

export interface SSEMessage {
  type: 'thought' | 'subtitle' | 'code' | 'code_done' | 'timeline' | 'done' | 'error';
  content?: string;
  data?: any;
}

export function useSSE(sessionId: string | null) {
  const [messages, setMessages] = useState<SSEMessage[]>([]);
  const [isConnected, setIsConnected] = useState(false);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (!sessionId) return;

    const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:8000';
    const eventSource = new EventSource(`${API_URL}/api/session/${sessionId}/stream`);

    eventSource.onopen = () => {
      setIsConnected(true);
      console.log('SSE connected');
    };

    eventSource.addEventListener('thought', (event) => {
      const data = JSON.parse(event.data);
      setMessages((prev) => [...prev, { type: 'thought', content: data.content }]);
    });

    eventSource.addEventListener('subtitle', (event) => {
      const data = JSON.parse(event.data);
      setMessages((prev) => [...prev, { type: 'subtitle', data }]);
    });

    eventSource.addEventListener('code', (event) => {
      const data = JSON.parse(event.data);
      setMessages((prev) => [...prev, { type: 'code', content: data.content }]);
    });

    eventSource.addEventListener('code_done', () => {
      setMessages((prev) => [...prev, { type: 'code_done' }]);
    });

    eventSource.addEventListener('timeline', (event) => {
      const data = JSON.parse(event.data);
      setMessages((prev) => [...prev, { type: 'timeline', data }]);
    });

    eventSource.addEventListener('done', () => {
      setMessages((prev) => [...prev, { type: 'done' }]);
      eventSource.close();
      setIsConnected(false);
    });

    eventSource.addEventListener('error', (event) => {
      const data = JSON.parse((event as MessageEvent).data);
      setError(data.message);
      eventSource.close();
      setIsConnected(false);
    });

    eventSource.onerror = () => {
      setError('Connection failed');
      eventSource.close();
      setIsConnected(false);
    };

    return () => {
      eventSource.close();
    };
  }, [sessionId]);

  return { messages, isConnected, error };
}
```

### 6.3 useVideoSync Hook

```typescript
// src/hooks/useVideoSync.ts
import { useEffect, useState } from 'react';
import { Timeline, TimelineSegment } from '@/types/timeline';

export function useVideoSync(
  videoRef: React.RefObject<HTMLVideoElement>,
  timeline: Timeline | null
) {
  const [currentSegment, setCurrentSegment] = useState<TimelineSegment | null>(null);
  const [highlightedLines, setHighlightedLines] = useState<[number, number] | null>(null);

  useEffect(() => {
    const videoElement = videoRef.current;
    if (!videoElement || !timeline) return;

    const handleTimeUpdate = () => {
      const currentTime = videoElement.currentTime;

      // 找到当前时间对应的segment
      const segment = timeline.segments.find(
        (seg) => currentTime >= seg.startTime && currentTime < seg.endTime
      );

      if (segment) {
        setCurrentSegment(segment);

        // 解析代码行号 "10-25" -> [10, 25]
        if (segment.codeLines) {
          const [start, end] = segment.codeLines.split('-').map(Number);
          setHighlightedLines([start, end]);
        } else {
          setHighlightedLines(null);
        }
      }
    };

    videoElement.addEventListener('timeupdate', handleTimeUpdate);

    return () => {
      videoElement.removeEventListener('timeupdate', handleTimeUpdate);
    };
  }, [videoRef, timeline]);

  return { currentSegment, highlightedLines };
}
```

## 7. Monaco Editor组件

```typescript
// src/components/CodeEditor.tsx
import Editor from '@monaco-editor/react';
import { useRef, useEffect } from 'react';
import * as monaco from 'monaco-editor';

interface CodeEditorProps {
  code: string;
  onChange: (value: string) => void;
  highlightedLines: [number, number] | null;
}

export function CodeEditor({ code, onChange, highlightedLines }: CodeEditorProps) {
  const editorRef = useRef<monaco.editor.IStandaloneCodeEditor | null>(null);
  const decorationsRef = useRef<string[]>([]);

  const handleEditorDidMount = (editor: monaco.editor.IStandaloneCodeEditor) => {
    editorRef.current = editor;
  };

  useEffect(() => {
    if (!editorRef.current || !highlightedLines) return;

    const [startLine, endLine] = highlightedLines;
    const newDecorations = [
      {
        range: new monaco.Range(startLine, 1, endLine, 1),
        options: {
          isWholeLine: true,
          className: 'highlighted-code-line',
          glyphMarginClassName: 'highlighted-code-glyph'
        }
      }
    ];

    decorationsRef.current = editorRef.current.deltaDecorations(
      decorationsRef.current,
      newDecorations
    );
  }, [highlightedLines]);

  return (
    <Editor
      height="100%"
      language="python"
      theme="vs-dark"
      value={code}
      onChange={(value) => onChange(value || '')}
      onMount={handleEditorDidMount}
      options={{
        minimap: { enabled: false },
        fontSize: 14,
        lineNumbers: 'on',
        scrollBeyondLastLine: false,
        automaticLayout: true,
        tabSize: 4,
        wordWrap: 'on',
      }}
    />
  );
}
```

## 8. 样式定义

```css
/* src/index.css - 添加到现有样式 */

/* Monaco Editor代码高亮样式 */
.highlighted-code-line {
  background-color: rgba(59, 130, 246, 0.15) !important;
  border-left: 3px solid #3b82f6 !important;
}

.highlighted-code-glyph {
  background-color: #3b82f6 !important;
  width: 4px !important;
}

/* Pyodide加载动画 */
.pyodide-loading {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 2rem;
}

.pyodide-loading-spinner {
  border: 3px solid #f3f3f3;
  border-top: 3px solid #3b82f6;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
```

## 9. 环境变量配置

```bash
# .env
VITE_API_URL=http://localhost:8000
```

## 10. 修改HomePage集成

### 10.1 修改HomePage.tsx

在`src/components/HomePage.tsx`中添加视频URL提交逻辑：

```typescript
// 添加import
import { useNavigate } from 'react-router-dom';
import { api } from '../services/api';

export function HomePage() {
  const navigate = useNavigate();
  const [message, setMessage] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);

  const handleVideoToCode = async () => {
    if (!message.trim()) return;

    setIsSubmitting(true);
    try {
      const response = await api.createSession({
        videoUrl: message,
        language: 'python'
      });
      
      // 跳转到工作区
      navigate(`/workspace?session=${response.sessionId}`);
    } catch (error) {
      alert(error instanceof Error ? error.message : '创建会话失败');
    } finally {
      setIsSubmitting(false);
    }
  };

  // 修改Video to Code按钮
  const quickActions = [
    { 
      icon: Code2, 
      text: 'Video to Code',
      onClick: handleVideoToCode 
    },
    // ... 其他按钮
  ];
}
```

## 11. 开发启动命令

```bash
# 安装依赖
npm install

# 启动开发服务器
npm run dev

# 构建生产版本
npm run build
```

## 12. 重要注意事项

### 12.1 Pyodide性能优化
- 首次加载需要3-5秒
- 建议在应用启动时就初始化
- 显示明确的加载状态

### 12.2 Monaco Editor
- 支持代码编辑和语法高亮
- 需要正确配置decorations实现高亮
- 注意内存管理，清理旧的decorations

### 12.3 SSE连接
- 需要处理连接中断情况
- 可以通过GET /api/session/{id}恢复状态
- 注意浏览器兼容性

### 12.4 视频同步
- timeupdate事件频率较高，注意性能
- 使用防抖或限流优化
- 确保时间轴数据格式正确

## 13. 调试技巧

```typescript
// 开启Monaco Editor调试
localStorage.setItem('monaco-debug', 'true');

// 查看Pyodide加载状态
console.log(pyodide.version);
console.log(pyodide.runPython('import sys; sys.version'));

// SSE调试
eventSource.addEventListener('message', (e) => {
  console.log('SSE message:', e.data);
});
```
