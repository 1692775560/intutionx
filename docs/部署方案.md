# 部署方案

> Mora项目的完整部署指南

## 1. 开发环境部署

### 1.1 前置要求

- **操作系统**: macOS / Linux / Windows
- **Node.js**: 18+ 
- **Python**: 3.11+
- **PostgreSQL**: 15+
- **Redis**: 7+
- **Docker**: 24+ (可选)

### 1.2 后端部署

```bash
# 1. 创建项目目录
mkdir mora-backend
cd mora-backend

# 2. 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Linux/Mac
# venv\Scripts\activate  # Windows

# 3. 安装依赖
pip install -r requirements.txt

# 4. 配置环境变量
cp .env.example .env
# 编辑 .env 填写API Keys和数据库配置

# 5. 初始化数据库
# 确保PostgreSQL已启动
createdb mora

# 6. 运行数据库迁移
alembic upgrade head

# 7. 启动后端服务
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 1.3 前端部署

```bash
# 1. 进入前端目录
cd "Video Conversion App Design"

# 2. 安装依赖
npm install

# 3. 配置环境变量
echo "VITE_API_URL=http://localhost:8000" > .env

# 4. 启动开发服务器
npm run dev
```

### 1.4 Docker Compose（推荐）

**docker-compose.yml**:
```yaml
version: '3.8'

services:
  # PostgreSQL数据库
  postgres:
    image: postgres:15-alpine
    container_name: mora-postgres
    environment:
      POSTGRES_DB: mora
      POSTGRES_USER: mora
      POSTGRES_PASSWORD: mora_password_123
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mora"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis缓存
  redis:
    image: redis:7-alpine
    container_name: mora-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # 后端API
  backend:
    build:
      context: ./mora-backend
      dockerfile: Dockerfile
    container_name: mora-backend
    environment:
      DATABASE_URL: postgresql://mora:mora_password_123@postgres:5432/mora
      REDIS_URL: redis://redis:6379/0
      BIBIGPT_API_KEY: ${BIBIGPT_API_KEY}
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY}
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./mora-backend:/app
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

  # 前端（开发环境）
  frontend:
    build:
      context: ./Video Conversion App Design
      dockerfile: Dockerfile.dev
    container_name: mora-frontend
    environment:
      VITE_API_URL: http://localhost:8000
    ports:
      - "5173:5173"
    volumes:
      - ./Video Conversion App Design:/app
      - /app/node_modules
    command: npm run dev -- --host

volumes:
  postgres_data:
  redis_data:
```

**启动开发环境**:
```bash
# 创建 .env 文件
cat > .env << EOF
BIBIGPT_API_KEY=your_key_here
DEEPSEEK_API_KEY=your_key_here
EOF

# 启动所有服务
docker-compose up -d

# 查看日志
docker-compose logs -f backend

# 停止服务
docker-compose down
```

---

## 2. 生产环境部署

### 2.1 方案对比

| 方案 | 优点 | 缺点 | 成本 | 适用场景 |
|------|------|------|------|----------|
| **Vercel + Railway** | 配置简单，自动部署 | 有使用限制 | 低 | MVP/小型项目 |
| **AWS/GCP** | 可扩展，性能好 | 配置复杂 | 中-高 | 中大型项目 |
| **VPS (DigitalOcean)** | 完全控制 | 需要运维 | 中 | 有运维能力团队 |

### 2.2 方案一：Vercel + Railway（推荐MVP）

#### 2.2.1 前端部署（Vercel）

```bash
# 1. 安装Vercel CLI
npm install -g vercel

# 2. 登录Vercel
vercel login

# 3. 部署
cd "Video Conversion App Design"
vercel

# 4. 设置环境变量
vercel env add VITE_API_URL production
# 输入: https://your-backend.railway.app

# 5. 生产部署
vercel --prod
```

**vercel.json**:
```json
{
  "buildCommand": "npm run build",
  "outputDirectory": "dist",
  "devCommand": "npm run dev",
  "installCommand": "npm install",
  "framework": "vite",
  "rewrites": [
    { "source": "/(.*)", "destination": "/index.html" }
  ]
}
```

#### 2.2.2 后端部署（Railway）

1. 访问 [railway.app](https://railway.app)
2. 连接GitHub仓库
3. 添加PostgreSQL和Redis服务
4. 配置环境变量：
   - `DATABASE_URL` (自动生成)
   - `REDIS_URL` (自动生成)
   - `BIBIGPT_API_KEY`
   - `DEEPSEEK_API_KEY`
5. 部署完成后获取域名

**railway.json**:
```json
{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "NIXPACKS"
  },
  "deploy": {
    "startCommand": "uvicorn app.main:app --host 0.0.0.0 --port $PORT",
    "healthcheckPath": "/health",
    "healthcheckTimeout": 100
  }
}
```

### 2.3 方案二：AWS部署（可扩展方案）

#### 架构图

```
┌─────────────────────────────────────────┐
│          CloudFront (CDN)               │
│          + S3 (静态文件)                 │
└─────────────┬───────────────────────────┘
              │
┌─────────────▼───────────────────────────┐
│      Application Load Balancer          │
└─────────────┬───────────────────────────┘
              │
┌─────────────▼───────────────────────────┐
│      ECS/Fargate (Backend API)          │
│      + Auto Scaling                      │
└─────┬──────────────┬─────────────────────┘
      │              │
┌─────▼─────┐  ┌────▼─────────┐
│   RDS     │  │ ElastiCache  │
│(PostgreSQL)│  │   (Redis)    │
└───────────┘  └──────────────┘
```

#### 部署步骤

**1. 前端部署到S3 + CloudFront**

```bash
# 构建前端
npm run build

# 上传到S3
aws s3 sync dist/ s3://mora-frontend-bucket

# 创建CloudFront分发
aws cloudfront create-distribution \
  --origin-domain-name mora-frontend-bucket.s3.amazonaws.com
```

**2. 后端部署到ECS**

```dockerfile
# mora-backend/Dockerfile
FROM python:3.11-slim

WORKDIR /app

# 安装依赖
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 复制代码
COPY . .

# 运行迁移和启动
CMD ["sh", "-c", "alembic upgrade head && uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 4"]
```

```bash
# 构建镜像
docker build -t mora-backend .

# 推送到ECR
aws ecr get-login-password | docker login --username AWS --password-stdin $ECR_REGISTRY
docker tag mora-backend:latest $ECR_REGISTRY/mora-backend:latest
docker push $ECR_REGISTRY/mora-backend:latest

# 部署到ECS
aws ecs update-service --cluster mora-cluster --service mora-backend --force-new-deployment
```

**3. 配置RDS和ElastiCache**

```bash
# 创建RDS PostgreSQL
aws rds create-db-instance \
  --db-instance-identifier mora-postgres \
  --db-instance-class db.t3.micro \
  --engine postgres \
  --master-username mora \
  --master-user-password YourSecurePassword

# 创建ElastiCache Redis
aws elasticache create-cache-cluster \
  --cache-cluster-id mora-redis \
  --cache-node-type cache.t3.micro \
  --engine redis
```

### 2.4 方案三：VPS部署（DigitalOcean）

#### 服务器配置

- **CPU**: 2核
- **RAM**: 4GB
- **存储**: 80GB SSD
- **系统**: Ubuntu 22.04 LTS

#### 部署脚本

```bash
#!/bin/bash
# deploy.sh - VPS自动部署脚本

set -e

echo "=== Mora项目生产环境部署 ==="

# 1. 更新系统
sudo apt update && sudo apt upgrade -y

# 2. 安装依赖
sudo apt install -y python3.11 python3.11-venv postgresql redis-server nginx certbot python3-certbot-nginx

# 3. 创建用户
sudo useradd -m -s /bin/bash mora
sudo usermod -aG sudo mora

# 4. 克隆代码
cd /home/mora
git clone https://github.com/your-repo/mora.git
cd mora

# 5. 后端设置
cd mora-backend
python3.11 -m venv venv
source venv/bin/activate
pip install -r requirements.txt

# 6. 配置环境变量
cat > .env << EOF
DATABASE_URL=postgresql://mora:password@localhost/mora
REDIS_URL=redis://localhost:6379/0
BIBIGPT_API_KEY=$BIBIGPT_KEY
DEEPSEEK_API_KEY=$DEEPSEEK_KEY
DEBUG=False
EOF

# 7. 初始化数据库
sudo -u postgres psql -c "CREATE DATABASE mora;"
sudo -u postgres psql -c "CREATE USER mora WITH PASSWORD 'password';"
sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE mora TO mora;"
alembic upgrade head

# 8. 创建systemd服务
sudo cat > /etc/systemd/system/mora-backend.service << EOF
[Unit]
Description=Mora Backend API
After=network.target postgresql.service redis.service

[Service]
Type=simple
User=mora
WorkingDirectory=/home/mora/mora/mora-backend
Environment="PATH=/home/mora/mora/mora-backend/venv/bin"
ExecStart=/home/mora/mora/mora-backend/venv/bin/gunicorn app.main:app -w 4 -k uvicorn.workers.UvicornWorker -b 0.0.0.0:8000
Restart=always

[Install]
WantedBy=multi-user.target
EOF

# 9. 启动后端服务
sudo systemctl daemon-reload
sudo systemctl enable mora-backend
sudo systemctl start mora-backend

# 10. 前端构建
cd ../Video\ Conversion\ App\ Design
npm install
VITE_API_URL=https://api.mora.app npm run build

# 11. 配置Nginx
sudo cat > /etc/nginx/sites-available/mora << EOF
server {
    listen 80;
    server_name mora.app www.mora.app;

    # 前端
    location / {
        root /home/mora/mora/Video\ Conversion\ App\ Design/dist;
        try_files \$uri \$uri/ /index.html;
    }

    # 后端API
    location /api {
        proxy_pass http://localhost:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_cache_bypass \$http_upgrade;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }
}
EOF

sudo ln -s /etc/nginx/sites-available/mora /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx

# 12. 配置SSL证书
sudo certbot --nginx -d mora.app -d www.mora.app

echo "=== 部署完成 ==="
echo "前端: https://mora.app"
echo "API: https://mora.app/api"
```

---

## 3. CI/CD配置

### 3.1 GitHub Actions

**.github/workflows/deploy.yml**:
```yaml
name: Deploy Mora

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # 后端测试
  test-backend:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          cd mora-backend
          pip install -r requirements.txt
      - name: Run tests
        run: |
          cd mora-backend
          pytest tests/

  # 前端测试
  test-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      - name: Install dependencies
        run: |
          cd "Video Conversion App Design"
          npm install
      - name: Build
        run: |
          cd "Video Conversion App Design"
          npm run build

  # 部署到生产环境
  deploy:
    needs: [test-backend, test-frontend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3
      
      # 部署后端到Railway
      - name: Deploy Backend
        run: |
          npm install -g @railway/cli
          railway up -s mora-backend
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      
      # 部署前端到Vercel
      - name: Deploy Frontend
        run: |
          npm install -g vercel
          cd "Video Conversion App Design"
          vercel --prod --token=${{ secrets.VERCEL_TOKEN }}
```

---

## 4. 环境变量管理

### 4.1 开发环境

```bash
# .env.development
DATABASE_URL=postgresql://mora:password@localhost:5432/mora
REDIS_URL=redis://localhost:6379/0
BIBIGPT_API_KEY=dev_key
DEEPSEEK_API_KEY=dev_key
DEBUG=True
CORS_ORIGINS=["http://localhost:5173"]
```

### 4.2 生产环境

```bash
# .env.production（不要提交到Git！）
DATABASE_URL=postgresql://user:pass@prod-db.com:5432/mora
REDIS_URL=redis://prod-redis.com:6379/0
BIBIGPT_API_KEY=prod_key_xxxxx
DEEPSEEK_API_KEY=prod_key_xxxxx
DEBUG=False
CORS_ORIGINS=["https://mora.app"]
MAX_REQUESTS_PER_MINUTE=100
ENABLE_CACHE=true
```

### 4.3 密钥管理

**使用AWS Secrets Manager**:
```python
# app/config.py
import boto3
import json

def get_secret(secret_name):
    client = boto3.client('secretsmanager', region_name='us-east-1')
    response = client.get_secret_value(SecretId=secret_name)
    return json.loads(response['SecretString'])

# 使用
secrets = get_secret('mora/production')
BIBIGPT_API_KEY = secrets['BIBIGPT_API_KEY']
```

---

## 5. 监控和日志

### 5.1 应用监控（Sentry）

```python
# app/main.py
import sentry_sdk
from sentry_sdk.integrations.fastapi import FastApiIntegration

sentry_sdk.init(
    dsn="https://xxx@xxx.ingest.sentry.io/xxx",
    integrations=[FastApiIntegration()],
    traces_sample_rate=1.0,
    environment="production"
)
```

### 5.2 日志聚合（CloudWatch/Datadog）

```python
import logging
from logging.handlers import RotatingFileHandler

# 文件日志
handler = RotatingFileHandler(
    'mora.log',
    maxBytes=10000000,  # 10MB
    backupCount=5
)
handler.setFormatter(logging.Formatter(
    '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
))

logger = logging.getLogger('mora')
logger.addHandler(handler)
```

### 5.3 性能监控

```python
# Prometheus metrics
from prometheus_fastapi_instrumentator import Instrumentator

Instrumentator().instrument(app).expose(app)
```

---

## 6. 备份策略

### 6.1 数据库备份

```bash
# 每日自动备份脚本
#!/bin/bash
# backup.sh

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backups/postgres"

# 备份数据库
pg_dump -U mora mora > $BACKUP_DIR/mora_$DATE.sql

# 压缩
gzip $BACKUP_DIR/mora_$DATE.sql

# 删除7天前的备份
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete

# 上传到S3
aws s3 cp $BACKUP_DIR/mora_$DATE.sql.gz s3://mora-backups/
```

**设置cron任务**:
```bash
# 每天凌晨3点执行
0 3 * * * /home/mora/backup.sh
```

### 6.2 Redis备份

```bash
# redis.conf
save 900 1
save 300 10
save 60 10000

# 手动备份
redis-cli BGSAVE
```

---

## 7. 性能优化

### 7.1 后端优化

```python
# 1. 使用连接池
engine = create_engine(
    DATABASE_URL,
    pool_size=20,
    max_overflow=40,
    pool_pre_ping=True
)

# 2. 启用Gzip压缩
from fastapi.middleware.gzip import GZipMiddleware
app.add_middleware(GZipMiddleware, minimum_size=1000)

# 3. 启用HTTP缓存
from fastapi.responses import Response
response.headers["Cache-Control"] = "public, max-age=3600"
```

### 7.2 前端优化

```typescript
// vite.config.ts
export default defineConfig({
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          'monaco': ['@monaco-editor/react'],
          'pyodide': ['pyodide'],
          'vendor': ['react', 'react-dom']
        }
      }
    },
    chunkSizeWarningLimit: 1000
  }
})
```

### 7.3 CDN配置

```nginx
# Nginx缓存配置
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

---

## 8. 故障排查

### 8.1 常见问题

| 问题 | 原因 | 解决方案 |
|------|------|---------|
| API超时 | BibiGPT/DeepSeek响应慢 | 增加timeout，添加重试 |
| SSE断开 | Nginx缓冲 | 添加`X-Accel-Buffering: no` |
| Pyodide加载失败 | CDN不稳定 | 使用自托管Pyodide |
| 数据库连接池耗尽 | 并发过高 | 增加pool_size |

### 8.2 日志查看

```bash
# Docker环境
docker-compose logs -f backend

# systemd环境
sudo journalctl -u mora-backend -f

# Nginx日志
sudo tail -f /var/log/nginx/error.log
```

---

## 9. 安全配置

### 9.1 HTTPS配置

```nginx
# 强制HTTPS
server {
    listen 80;
    server_name mora.app;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name mora.app;
    
    ssl_certificate /etc/letsencrypt/live/mora.app/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/mora.app/privkey.pem;
    
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
}
```

### 9.2 API安全

```python
# 限流
from slowapi import Limiter
limiter = Limiter(key_func=get_remote_address)

# CORS严格配置
app.add_middleware(
    CORSMiddleware,
    allow_origins=["https://mora.app"],
    allow_credentials=True,
    allow_methods=["GET", "POST"],
    allow_headers=["*"],
)

# API Key验证（如需要）
from fastapi.security import APIKeyHeader
api_key_header = APIKeyHeader(name="X-API-Key")
```

---

## 10. 成本估算

### 10.1 MVP阶段（Railway + Vercel）

| 服务 | 配置 | 月成本 |
|------|------|--------|
| Railway后端 | 2GB RAM | $5 |
| Railway PostgreSQL | Starter | $5 |
| Railway Redis | Starter | $5 |
| Vercel前端 | Hobby | $0 |
| BibiGPT API | 按量 | $10-30 |
| DeepSeek API | 按量 | $20-50 |
| **总计** | | **$45-95/月** |

### 10.2 生产阶段（AWS）

| 服务 | 配置 | 月成本 |
|------|------|--------|
| ECS Fargate | 2 tasks | $40 |
| RDS PostgreSQL | db.t3.micro | $15 |
| ElastiCache Redis | cache.t3.micro | $12 |
| S3 + CloudFront | 100GB流量 | $10 |
| **总计** | | **$77/月** |

---

## 11. 检查清单

### 部署前检查

- [ ] 所有环境变量已配置
- [ ] API Keys已测试可用
- [ ] 数据库迁移已执行
- [ ] 前端构建成功
- [ ] 后端测试通过
- [ ] CORS配置正确
- [ ] SSL证书已配置

### 部署后检查

- [ ] 健康检查端点正常
- [ ] 前端可访问
- [ ] API可调用
- [ ] SSE连接正常
- [ ] 代码生成功能正常
- [ ] 监控和日志正常
- [ ] 备份任务已设置

---

## 12. 参考资源

- **Vercel文档**: https://vercel.com/docs
- **Railway文档**: https://docs.railway.app
- **FastAPI部署**: https://fastapi.tiangolo.com/deployment/
- **Let's Encrypt**: https://letsencrypt.org
- **Docker最佳实践**: https://docs.docker.com/develop/dev-best-practices/
